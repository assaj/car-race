<!DOCTYPE html>
<html>
<head>
	<title>CAR RACE</title>
</head>
<body>
	<button onclick="newPlayer()">Create a new player</button>
	<button onclick="gameReset()">Reset</button>
<canvas id="stage" width="600" height="600"></canvas>
<script type="text/javascript">
var time = 10, sqrtSize = 10, ctx, stage,numberOfPlayers = 1, colisorNumber, setOfTests,  testNumber, testSize = 9999999, testMoves = [], testSave = [], testTime, setOfTests = [], setOfScores = [], realTestNumber;
var px = [],py = [], alive = [],score = [], setOfColors = ["","red","blue","black","white","pink"], lastYPosition = 460;
window.onload = function(){
	stage = document.getElementById('stage');
	ctx = stage.getContext("2d");
	ctx.fillStyle = "grey";
	ctx.fillRect(0,0, stage.width, stage.height);
	newPlayer();
	testNumber = 0;
	realTestNumber = 0;
	testTime = 0;
}
setInterval(run,time);
function run(){

	ctx.fillStyle = "grey";
    ctx.fillRect(0,0, stage.width, stage.height);
	ctx.fillStyle = "yellow";
	ctx.fillRect(100,100,400,400);
	ctx.fillStyle = "green";
	ctx.fillRect(0,480,100,20);

	for(let x = 1; x < numberOfPlayers; x++){
			if(alive[x]){
				killPlayer(x);
				if(alive[x]){
					paintPlayer(x);
					setScore(x);
					rightMove(x);
				}
			}
	}	
	gameReset();
}
function paintPlayer(playerNumber){
	ctx.fillStyle = setOfColors[playerNumber];
	ctx.fillRect(px[playerNumber],py[playerNumber],20,20);//X,Y,WIDTH,HEIGHT
}
function rightMove(playerNumber){
	if(setOfTests[playerNumber][testNumber%11][testTime] == 0){
		randomMove(playerNumber);
	}else{
		playerMovement(setOfTests[playerNumber][testNumber%11][testTime],playerNumber);
	}
}
function XrightMove(playerNumber){
	let x = Math.floor((Math.random() * 10) + 1);
	if(x == 1){
		console.log("burro");
		randomMove(playerNumber);
	}else{
		if(setOfTests[playerNumber][testNumber%11][testTime] == 0){
			console.log("vazio");
			randomMove(playerNumber);
		}else{
			console.log("inteligente: "+testTime);
			console.log(setOfTests[playerNumber][testNumber%11]);
			console.log(setOfScores[playerNumber][testNumber%11]);
			playerMovement(setOfTests[playerNumber][testNumber%11][testTime],playerNumber);
		}
	}
}
function playerMovement(
	movement, playerNumber) {
		saveMovement(playerNumber, movement);
		lastYPosition = py[playerNumber];
	switch(movement){
		case 1://right
			px[playerNumber]+=20;
		break;
		case 2://left
			px[playerNumber]-=20;
		break;
		case 3://up
			py[playerNumber]-=20;
		break;
		case 4://down
			py[playerNumber]+=20;
		break;
	}
}
function saveMovement(playerNumber, movement){
	testMoves[playerNumber][testTime]= movement;
	testTime++;
}
function newPlayer(){
	if(numberOfPlayers > 5){
		alert("The max number of player is 5.");
	}else{
		px[numberOfPlayers] = (numberOfPlayers-1) * 20;
		py[numberOfPlayers] = 460;
		alive[numberOfPlayers] = true;
		score[numberOfPlayers] = 0.0;
		testMoves[numberOfPlayers] = [];
		setOfTests[numberOfPlayers] = [];
		setOfScores[numberOfPlayers] = [];
		for(let x = 0; x < 20; x++){
			setOfTests[numberOfPlayers][x] = [];
			for(let y = 0; y < 200; y++){
				setOfTests[numberOfPlayers][x][y] = 0;
			}
		}
		clearMoves(numberOfPlayers);

		numberOfPlayers++;
	}
}
function gameReset(){
	let gameOn = false;
	for(let i = 1; i < numberOfPlayers ; i++){
		if(alive[i]){
		 	gameOn = true;
		}
	}
	if(!gameOn || testTime > testSize){
		for(let x = 1; x < numberOfPlayers ; x++){
			//console.log(testMoves[x]+" Score: "+score[x]);
			constructor(testMoves[x],score[x],x);
			px[x] = (x-1) * 20;
			py[x] = 460;
			alive[x] = true;
			score[x] = 0;
			clearMoves(x);
			//paintPlayer(x);		
		}
		testTime = 0;
		testNumber++;
	}
}
function clearMoves(playerNumber){
	for(let i = 0; i < 2000; i++){
		testMoves[playerNumber][i] = 0;
	}
}
function clearTestAndScore(playerNumber, idx){
	for(var x = 0; x < idx; x++){
		setOfScores[playerNumber][10 - x] = 0;
		for (var i = 0; i < 2000; i++) {
			setOfTests[playerNumber][10 - x][i] = 0;
		}
	}
}
function killPlayer(playerNumber){
	if(px[playerNumber] >= 100 && py[playerNumber] >= 100 && py[playerNumber] < 500 && px[playerNumber] < 500){
		alive[playerNumber] = false;
		score[playerNumber] -= 100;
	}
	if(inColision(playerNumber)){
		alive[colisorNumber] = false;
		alive[playerNumber] = false;
		score[playerNumber] -= 100;
		score[colisorNumber] -= 100;
	}
	if(foul(playerNumber)){
		alive[playerNumber] = false;
		score[playerNumber] -= 100;
	}
	if(px[playerNumber] < 0 || px[playerNumber] > 600 || py[playerNumber] < 0 || py[playerNumber] > 600){
		alive[playerNumber] = false;
		score[playerNumber] -= 100;
	}
}
function foul(playerNumber){
	if(lastYPosition == 460 && py[playerNumber] == 480 && px[playerNumber] < 200){
		return true;
	}else{
		return false;
	}
}
function inColision(playerNumber){
	for(let x = 1; x <= numberOfPlayers; x++){
		if(x != playerNumber){
			if(px[x] == px[playerNumber] && py[x] == py[playerNumber]){
				colisorNumber = x;
				return true;
			}
		}
	}
	return false;
}
function randomMove(playerNumber){
	playerMovement(Math.floor((Math.random() * 4) + 1),playerNumber)
}

function setScore(playerNumber){
	if(px[playerNumber] < 200 && py[playerNumber] > 100 && py[playerNumber] < 500){
		score[playerNumber] += 23 -py[playerNumber]/20 ;
	}else if(px[playerNumber] > 200 && py[playerNumber] > 100 && py[playerNumber] < 500){
		score[playerNumber] += py[playerNumber]/20;
	}else if(py[playerNumber] < 100){
		score[playerNumber] += px[playerNumber]/20;
	}else if(py[playerNumber] >= 500){
		score[playerNumber] +=20 - px[playerNumber]/20;
	}
}

function constructor(testMoves, score, playerNumber){

	//TestMoves OK and score OK
	for (var i = 0; i < testMoves.length; i++) {
		setOfTests[playerNumber][testNumber%11][i] = testMoves[i];
	}
	setOfScores[playerNumber][testNumber%11] = score;
	
	//console.log(setOfTests[playerNumber][testNumber%11]+"  Associado a : "+setOfScores[playerNumber][testNumber%11]+" de numero: "+testNumber%11);  
	

	if(testNumber%10 == 0){
		//compileSetOfMoves(playerNumber);
		//console.log("COMPILANDO========================================");
		compiler(playerNumber);
		//	console.log("  Associado a : "+setOfScores[playerNumber][i]);
		
		//console.log("END========================================");
		//testNumber = 0;	
	}else{
		realTestNumber = 1;
	}
	realTestNumber = 1;
}
function compiler(playerNumber){
	let aux;
	let setAux = [];

	for(let x = 0; x < 11; x++){
		for(let y = 0; y < 11; y++){
			if(setOfScores[playerNumber][x] > setOfScores[playerNumber][y]){

				aux = setOfScores[playerNumber][x];
				setOfScores[playerNumber][x] = setOfScores[playerNumber][y];
				setOfScores[playerNumber][y] = aux;

				for (var i = 0; i < setOfTests[playerNumber][x].length; i++) {
					setAux[i] = setOfTests[playerNumber][x][i];
				}
				for (var i = 0; i < setOfTests[playerNumber][y].length; i++) {
					setOfTests[playerNumber][x][i] = setOfTests[playerNumber][y][i];
				}
				for (var i = 0; i < setAux.length; i++) {
					setOfTests[playerNumber][y][i] = setAux[i];
				}
			}
		}
	}

	clearTestAndScore(playerNumber,5);
}
</script>
</body>
</html>